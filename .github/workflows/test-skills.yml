name: Test Skills

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  validate-skills:
    name: Validate Skill Structure
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pytest pyyaml

      - name: Validate skill-creator
        run: |
          echo "Validating skill-creator..."
          test -f skill-creator/SKILL.md || exit 1
          test -x skill-creator/scripts/init_skill.py || exit 1
          test -x skill-creator/scripts/package_skill.py || exit 1
          echo "✓ skill-creator structure valid"

      - name: Validate task-decomposer
        run: |
          echo "Validating task-decomposer..."
          test -f task-decomposer/SKILL.md || exit 1
          test -x task-decomposer/scripts/analyze_task.py || exit 1
          test -x task-decomposer/scripts/linear_integration.py || exit 1
          echo "✓ task-decomposer structure valid"

      - name: Validate issue-manager
        run: |
          echo "Validating issue-manager..."
          test -f issue-manager/SKILL.md || exit 1
          test -x issue-manager/scripts/issue_operations.py || exit 1
          echo "✓ issue-manager structure valid"

      - name: Validate template-skill
        run: |
          echo "Validating template-skill..."
          test -f template-skill/SKILL.md || exit 1
          echo "✓ template-skill structure valid"

  test-python-scripts:
    name: Test Python Scripts
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pytest pyyaml

      - name: Run assignment detection tests
        run: |
          cd tests
          python -m pytest test_assignment_detection.py -v

      - name: Test analyze_task.py (dry-run)
        run: |
          cd task-decomposer/scripts
          python analyze_task.py "Test feature implementation" --project test || exit 1
          echo "✓ analyze_task.py works"

      - name: Test issue_operations.py (dry-run)
        run: |
          cd issue-manager/scripts
          python issue_operations.py query --filter "test" --dry-run || exit 1
          echo "✓ issue_operations.py works"

      - name: Test init_skill.py
        run: |
          cd skill-creator/scripts
          python init_skill.py test-skill "Test skill description" || exit 1
          test -d ../../test-skill || exit 1
          echo "✓ init_skill.py works"

  validate-yaml:
    name: Validate YAML Frontmatter
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Validate SKILL.md frontmatter
        run: |
          python3 << 'EOF'
          import yaml
          import sys
          import re

          skills = [
              'skill-creator/SKILL.md',
              'task-decomposer/SKILL.md',
              'issue-manager/SKILL.md',
              'template-skill/SKILL.md'
          ]

          failed = False

          for skill_file in skills:
              print(f"Validating {skill_file}...")

              with open(skill_file, 'r') as f:
                  content = f.read()

              # Extract YAML frontmatter
              match = re.match(r'^---\n(.*?)\n---', content, re.DOTALL)
              if not match:
                  print(f"  ✗ No YAML frontmatter found")
                  failed = True
                  continue

              try:
                  frontmatter = yaml.safe_load(match.group(1))
              except yaml.YAMLError as e:
                  print(f"  ✗ Invalid YAML: {e}")
                  failed = True
                  continue

              # Check required fields
              required = ['name', 'description', 'license']
              for field in required:
                  if field not in frontmatter:
                      print(f"  ✗ Missing required field: {field}")
                      failed = True
                  else:
                      print(f"  ✓ {field}: {frontmatter[field][:50]}...")

              # Validate naming convention
              if 'name' in frontmatter:
                  name = frontmatter['name']
                  if not re.match(r'^[a-z0-9-]+$', name):
                      print(f"  ✗ Invalid name format: {name}")
                      print(f"    Must be lowercase with hyphens only")
                      failed = True
                  else:
                      print(f"  ✓ Name format valid")

              print()

          if failed:
              sys.exit(1)
          else:
              print("✓ All SKILL.md files valid")
          EOF

  lint:
    name: Lint Documentation
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check for broken links in README
        run: |
          echo "Checking README.md for common issues..."

          # Check for placeholder text
          if grep -q "yourusername" README.md; then
            echo "✗ Found placeholder 'yourusername' in README.md"
            exit 1
          fi

          echo "✓ README.md looks good"

      - name: Validate documentation structure
        run: |
          echo "Checking documentation structure..."

          required_docs=(
            "README.md"
            "LICENSE"
            "CONTRIBUTING.md"
            "CHANGELOG.md"
            "docs/ASSIGNMENT_RULES.md"
            "docs/QUICK_REFERENCE_ASSIGNMENTS.md"
          )

          for doc in "${required_docs[@]}"; do
            if [ -f "$doc" ]; then
              echo "✓ $doc exists"
            else
              echo "✗ $doc missing"
              exit 1
            fi
          done

          echo "✓ All required documentation present"

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check for sensitive data
        run: |
          echo "Scanning for sensitive data..."

          # Check for hardcoded API keys (exclude placeholder examples)
          if grep -r "lin_api_[a-zA-Z0-9]\{20,\}" --include="*.py" --exclude-dir=docs --exclude-dir=examples .; then
            echo "✗ Found potential API keys in code"
            exit 1
          fi

          # Check for other secrets patterns (exclude placeholders)
          if grep -r -E "(password|secret|token)\s*=\s*['\"][^'\"]{20,}" --include="*.py" .; then
            echo "✗ Found potential hardcoded secrets"
            exit 1
          fi

          echo "✓ No sensitive data found"

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [validate-skills, test-python-scripts, validate-yaml, lint, security]

    steps:
      - uses: actions/checkout@v4

      - name: Generate summary
        run: |
          echo "# Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ All validations passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Skills Validated" >> $GITHUB_STEP_SUMMARY
          echo "- skill-creator" >> $GITHUB_STEP_SUMMARY
          echo "- task-decomposer" >> $GITHUB_STEP_SUMMARY
          echo "- issue-manager" >> $GITHUB_STEP_SUMMARY
          echo "- template-skill" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Tests Run" >> $GITHUB_STEP_SUMMARY
          echo "- Assignment detection tests" >> $GITHUB_STEP_SUMMARY
          echo "- Python script dry-runs" >> $GITHUB_STEP_SUMMARY
          echo "- YAML frontmatter validation" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation structure" >> $GITHUB_STEP_SUMMARY
          echo "- Security scan" >> $GITHUB_STEP_SUMMARY
